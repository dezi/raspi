From 7e39f7edb295aabf272a0b1828863b8c92d841c3 Mon Sep 17 00:00:00 2001
From: dezi <dezi@kappa-mm.de>
Date: Sun, 24 Mar 2013 07:14:05 +0000
Subject: [PATCH] UTF8 Charset nfd/nfc Encoding

---
 xbmc/addons/Scraper.cpp         |   1 +
 xbmc/utils/CharsetConverter.cpp | 111 ++++++++++++++++++++++++++++++++++++++++
 xbmc/utils/CharsetConverter.h   |   1 +
 3 files changed, 113 insertions(+)

diff --git a/xbmc/addons/Scraper.cpp b/xbmc/addons/Scraper.cpp
index a7c373e..71068a6 100644
--- a/xbmc/addons/Scraper.cpp
+++ b/xbmc/addons/Scraper.cpp
@@ -501,6 +501,7 @@ static bool RelevanceSortFunction(const CScraperUrl &left, const CScraperUrl &ri
   sTitle.ToLower();
 
   vector<CStdString> vcsIn(1);
+  g_charsetConverter.utf8ToUtf8NFC(sTitle);
   g_charsetConverter.utf8To(SearchStringEncoding(), sTitle, vcsIn[0]);
   CURL::Encode(vcsIn[0]);
   if (!sYear.IsEmpty())
diff --git a/xbmc/utils/CharsetConverter.cpp b/xbmc/utils/CharsetConverter.cpp
index 4e37b7d..153dc93 100644
--- a/xbmc/utils/CharsetConverter.cpp
+++ b/xbmc/utils/CharsetConverter.cpp
@@ -477,6 +477,117 @@ void CCharsetConverter::stringCharsetToUtf8(const CStdStringA& strSourceCharset,
   iconv_close(iconvString);
 }
 
+void CCharsetConverter::utf8ToUtf8NFC(CStdStringA& strSourceDest)
+{
+  // To keep stuff simple, we only check all decomposable
+  // simple letter character candidates.
+  // Sample: 0x41 0xcc 0x88 => 0xc3 0x84 (&adieresis; or &auml;)
+  int NFD_NFC_tupels[] =
+  {
+    0x41cc80, 0xc380, 0x45cc80, 0xc388, 0x49cc80, 0xc38c, 0x4ecc80, 0xc7b8, 
+    0x4fcc80, 0xc392, 0x55cc80, 0xc399, 0x61cc80, 0xc3a0, 0x65cc80, 0xc3a8, 
+    0x69cc80, 0xc3ac, 0x6ecc80, 0xc7b9, 0x6fcc80, 0xc3b2, 0x75cc80, 0xc3b9, 
+    0x41cc81, 0xc381, 0x43cc81, 0xc486, 0x45cc81, 0xc389, 0x47cc81, 0xc7b4, 
+    0x49cc81, 0xc38d, 0x4ccc81, 0xc4b9, 0x4ecc81, 0xc583, 0x4fcc81, 0xc393, 
+    0x52cc81, 0xc594, 0x53cc81, 0xc59a, 0x55cc81, 0xc39a, 0x59cc81, 0xc39d, 
+    0x5acc81, 0xc5b9, 0x61cc81, 0xc3a1, 0x63cc81, 0xc487, 0x65cc81, 0xc3a9, 
+    0x67cc81, 0xc7b5, 0x69cc81, 0xc3ad, 0x6ccc81, 0xc4ba, 0x6ecc81, 0xc584, 
+    0x6fcc81, 0xc3b3, 0x72cc81, 0xc595, 0x73cc81, 0xc59b, 0x75cc81, 0xc3ba, 
+    0x79cc81, 0xc3bd, 0x7acc81, 0xc5ba, 0x41cc82, 0xc382, 0x43cc82, 0xc488, 
+    0x45cc82, 0xc38a, 0x47cc82, 0xc49c, 0x48cc82, 0xc4a4, 0x49cc82, 0xc38e, 
+    0x4acc82, 0xc4b4, 0x4fcc82, 0xc394, 0x53cc82, 0xc59c, 0x55cc82, 0xc39b, 
+    0x57cc82, 0xc5b4, 0x59cc82, 0xc5b6, 0x61cc82, 0xc3a2, 0x63cc82, 0xc489, 
+    0x65cc82, 0xc3aa, 0x67cc82, 0xc49d, 0x68cc82, 0xc4a5, 0x69cc82, 0xc3ae, 
+    0x6acc82, 0xc4b5, 0x6fcc82, 0xc3b4, 0x73cc82, 0xc59d, 0x75cc82, 0xc3bb, 
+    0x77cc82, 0xc5b5, 0x79cc82, 0xc5b7, 0x41cc83, 0xc383, 0x49cc83, 0xc4a8, 
+    0x4ecc83, 0xc391, 0x4fcc83, 0xc395, 0x55cc83, 0xc5a8, 0x61cc83, 0xc3a3, 
+    0x69cc83, 0xc4a9, 0x6ecc83, 0xc3b1, 0x6fcc83, 0xc3b5, 0x75cc83, 0xc5a9, 
+    0x41cc84, 0xc480, 0x45cc84, 0xc492, 0x49cc84, 0xc4aa, 0x4fcc84, 0xc58c, 
+    0x55cc84, 0xc5aa, 0x59cc84, 0xc8b2, 0x61cc84, 0xc481, 0x65cc84, 0xc493, 
+    0x69cc84, 0xc4ab, 0x6fcc84, 0xc58d, 0x75cc84, 0xc5ab, 0x79cc84, 0xc8b3, 
+    0x41cc86, 0xc482, 0x45cc86, 0xc494, 0x47cc86, 0xc49e, 0x49cc86, 0xc4ac, 
+    0x4fcc86, 0xc58e, 0x55cc86, 0xc5ac, 0x61cc86, 0xc483, 0x65cc86, 0xc495, 
+    0x67cc86, 0xc49f, 0x69cc86, 0xc4ad, 0x6fcc86, 0xc58f, 0x75cc86, 0xc5ad, 
+    0x41cc87, 0xc8a6, 0x43cc87, 0xc48a, 0x45cc87, 0xc496, 0x47cc87, 0xc4a0, 
+    0x49cc87, 0xc4b0, 0x4fcc87, 0xc8ae, 0x5acc87, 0xc5bb, 0x61cc87, 0xc8a7, 
+    0x63cc87, 0xc48b, 0x65cc87, 0xc497, 0x67cc87, 0xc4a1, 0x6fcc87, 0xc8af, 
+    0x7acc87, 0xc5bc, 0x41cc88, 0xc384, 0x45cc88, 0xc38b, 0x49cc88, 0xc38f, 
+    0x4fcc88, 0xc396, 0x55cc88, 0xc39c, 0x59cc88, 0xc5b8, 0x61cc88, 0xc3a4, 
+    0x65cc88, 0xc3ab, 0x69cc88, 0xc3af, 0x6fcc88, 0xc3b6, 0x75cc88, 0xc3bc, 
+    0x79cc88, 0xc3bf, 0x41cc8a, 0xc385, 0x55cc8a, 0xc5ae, 0x61cc8a, 0xc3a5, 
+    0x75cc8a, 0xc5af, 0x4fcc8b, 0xc590, 0x55cc8b, 0xc5b0, 0x6fcc8b, 0xc591, 
+    0x75cc8b, 0xc5b1, 0x41cc8c, 0xc78d, 0x43cc8c, 0xc48c, 0x44cc8c, 0xc48e, 
+    0x45cc8c, 0xc49a, 0x47cc8c, 0xc7a6, 0x48cc8c, 0xc89e, 0x49cc8c, 0xc78f, 
+    0x4bcc8c, 0xc7a8, 0x4ccc8c, 0xc4bd, 0x4ecc8c, 0xc587, 0x4fcc8c, 0xc791, 
+    0x52cc8c, 0xc598, 0x53cc8c, 0xc5a0, 0x54cc8c, 0xc5a4, 0x55cc8c, 0xc793, 
+    0x5acc8c, 0xc5bd, 0x61cc8c, 0xc78e, 0x63cc8c, 0xc48d, 0x64cc8c, 0xc48f, 
+    0x65cc8c, 0xc49b, 0x67cc8c, 0xc7a7, 0x68cc8c, 0xc89f, 0x69cc8c, 0xc790, 
+    0x6acc8c, 0xc7b0, 0x6bcc8c, 0xc7a9, 0x6ccc8c, 0xc4be, 0x6ecc8c, 0xc588, 
+    0x6fcc8c, 0xc792, 0x72cc8c, 0xc599, 0x73cc8c, 0xc5a1, 0x74cc8c, 0xc5a5, 
+    0x75cc8c, 0xc794, 0x7acc8c, 0xc5be, 0x41cc8f, 0xc880, 0x45cc8f, 0xc884, 
+    0x49cc8f, 0xc888, 0x4fcc8f, 0xc88c, 0x52cc8f, 0xc890, 0x55cc8f, 0xc894, 
+    0x61cc8f, 0xc881, 0x65cc8f, 0xc885, 0x69cc8f, 0xc889, 0x6fcc8f, 0xc88d, 
+    0x72cc8f, 0xc891, 0x75cc8f, 0xc895, 0x41cc91, 0xc882, 0x45cc91, 0xc886, 
+    0x49cc91, 0xc88a, 0x4fcc91, 0xc88e, 0x52cc91, 0xc892, 0x55cc91, 0xc896, 
+    0x61cc91, 0xc883, 0x65cc91, 0xc887, 0x69cc91, 0xc88b, 0x6fcc91, 0xc88f, 
+    0x72cc91, 0xc893, 0x75cc91, 0xc897, 0x4fcc9b, 0xc6a0, 0x55cc9b, 0xc6af, 
+    0x6fcc9b, 0xc6a1, 0x75cc9b, 0xc6b0, 0x53cca6, 0xc898, 0x54cca6, 0xc89a, 
+    0x73cca6, 0xc899, 0x74cca6, 0xc89b, 0x43cca7, 0xc387, 0x45cca7, 0xc8a8, 
+    0x47cca7, 0xc4a2, 0x4bcca7, 0xc4b6, 0x4ccca7, 0xc4bb, 0x4ecca7, 0xc585, 
+    0x52cca7, 0xc596, 0x53cca7, 0xc59e, 0x54cca7, 0xc5a2, 0x63cca7, 0xc3a7, 
+    0x65cca7, 0xc8a9, 0x67cca7, 0xc4a3, 0x6bcca7, 0xc4b7, 0x6ccca7, 0xc4bc, 
+    0x6ecca7, 0xc586, 0x72cca7, 0xc597, 0x73cca7, 0xc59f, 0x74cca7, 0xc5a3, 
+    0x41cca8, 0xc484, 0x45cca8, 0xc498, 0x49cca8, 0xc4ae, 0x4fcca8, 0xc7aa, 
+    0x55cca8, 0xc5b2, 0x61cca8, 0xc485, 0x65cca8, 0xc499, 0x69cca8, 0xc4af, 
+    0x6fcca8, 0xc7ab, 0x75cca8, 0xc5b3, 0x41cd80, 0xc380, 0x45cd80, 0xc388, 
+    0x49cd80, 0xc38c, 0x4ecd80, 0xc7b8, 0x4fcd80, 0xc392, 0x55cd80, 0xc399, 
+    0x61cd80, 0xc3a0, 0x65cd80, 0xc3a8, 0x69cd80, 0xc3ac, 0x6ecd80, 0xc7b9, 
+    0x6fcd80, 0xc3b2, 0x75cd80, 0xc3b9, 0x41cd81, 0xc381, 0x43cd81, 0xc486, 
+    0x45cd81, 0xc389, 0x47cd81, 0xc7b4, 0x49cd81, 0xc38d, 0x4ccd81, 0xc4b9, 
+    0x4ecd81, 0xc583, 0x4fcd81, 0xc393, 0x52cd81, 0xc594, 0x53cd81, 0xc59a, 
+    0x55cd81, 0xc39a, 0x59cd81, 0xc39d, 0x5acd81, 0xc5b9, 0x61cd81, 0xc3a1, 
+    0x63cd81, 0xc487, 0x65cd81, 0xc3a9, 0x67cd81, 0xc7b5, 0x69cd81, 0xc3ad, 
+    0x6ccd81, 0xc4ba, 0x6ecd81, 0xc584, 0x6fcd81, 0xc3b3, 0x72cd81, 0xc595, 
+    0x73cd81, 0xc59b, 0x75cd81, 0xc3ba, 0x79cd81, 0xc3bd, 0x7acd81, 0xc5ba, 
+    0x55cd84, 0xc797, 0x75cd84, 0xc798, 0
+  };
+
+  CStdStringA strDest;
+
+  strDest.reserve(strSourceDest.length());
+
+  int i = 0;
+  for (; i < (int)strSourceDest.size() - 2; ++i)
+  {
+    int kar  = (unsigned char)strSourceDest[i];
+    int kar1 = (unsigned char)strSourceDest[i+1];
+    int kar2 = (unsigned char)strSourceDest[i+2];
+
+    if (((kar1 == 0xcc) || (kar1 == 0xcd)) && (kar2 >= 0x80))
+    {
+      int nfd  = (kar << 16) | (kar1 << 8) | kar2;
+      int skip = false;
+
+      for (int j = 0; NFD_NFC_tupels[j]; j+=2)
+      {
+        if (NFD_NFC_tupels[j] == nfd)
+        {
+          strDest += NFD_NFC_tupels[j+1] >> 8;
+          strDest += NFD_NFC_tupels[j+1] & 0xff;
+          skip = true;
+          i+=2;
+          break;
+        }
+      }
+      if(skip) continue;
+    }
+    strDest += kar;
+  }
+  for (; i < (int)strSourceDest.size(); ++i)
+    strDest += strSourceDest[i];
+  strSourceDest = strDest;
+}
+
 void CCharsetConverter::utf8To(const CStdStringA& strDestCharset, const CStdStringA& strSource, CStdStringA& strDest)
 {
   if (strDestCharset == "UTF-8")
diff --git a/xbmc/utils/CharsetConverter.h b/xbmc/utils/CharsetConverter.h
index 62780aa..a7ebb6a 100644
--- a/xbmc/utils/CharsetConverter.h
+++ b/xbmc/utils/CharsetConverter.h
@@ -46,6 +46,7 @@ class CCharsetConverter
 
   void utf8ToStringCharset(CStdStringA& strSourceDest);
   void utf8ToSystem(CStdStringA& strSourceDest);
+  void utf8ToUtf8NFC(CStdStringA& strSourceDest);
 
   void utf8To(const CStdStringA& strDestCharset, const CStdStringA& strSource, CStdStringA& strDest);
   void utf8To(const CStdStringA& strDestCharset, const CStdStringA& strSource, CStdString16& strDest);
-- 
1.8.1.5

